package sqli

import(
	"govwa/util/database"
	"net/http"
	"fmt"
)
import "govwa/util"

type User struct{
	Id int `json:"id"`
	Name string `json:"name"`
}

func New()*User{
	return nil
}
func UnsafeGetData(r *http.Request)(User, error){
	db, err := database.Connect()
	if err != nil{
		return User{},err
	}
	defer db.Close()
	//get data from clien
	uid := r.URL.Query().Get("uid")
	sql := fmt.Sprintf("SELECT * FROM users where id=%s",uid) //unsafe query. will cause big sql injection attack
	rows, err := db.Query(sql)
	if err != nil{
		return User{}, err
	}
	defer rows.Close()
	//var data []User
	var user = User{}
	for rows.Next(){
		err = rows.Scan(&user.Id, &user.Name)
		if err != nil{
			return User{}, err
		}
	}
	return user,nil

}
func SafeGetData(r *http.Request)(User, error){
	db, err := database.Connect()
	if err != nil{
		return User{},err
	}
	defer db.Close()
	//get data from clien
	uid := r.URL.Query().Get("uid")
	sql := fmt.Sprintf("SELECT * FROM users where id=?") //set safe query

	stmtOut, err := db.Prepare(sql) //prepare statement 
	if err != nil{
		return User{}, err
	}
	defer stmtOut.Close()
	var user = User{}
	err = stmtOut.QueryRow(uid).Scan(&user.Id, &user.Name)
	if err != nil{
		return User{}, err
	}
	return user,nil

}

func getUserHandler(w http.ResponseWriter, r *http.Request) {
	data, err := UnsafeGetData(r) //default function set to unsafe
	if util.CheckLevel(r) {            //if level == high
		data, err = SafeGetData(r)
	}
	if err != nil {
		fmt.Println(err.Error())
	}
	util.RenderAsJson(w, data)
}