package sqli

import(
	"secureCodingLab/util/database"
	"net/http"
	"fmt"
)


type User struct{
	Id int `json:"id"`
	Name string `json:"name"`
}

func UnsafeGetData(r *http.Request)(User, error){
	db, err := database.Connect()
	if err != nil{
		return User{},err
	}
	defer db.Close()
	//get data from clien
	uid := r.URL.Query().Get("uid")
	sql := fmt.Sprintf("SELECT * FROM users where id=%s",uid) //unsafe query. will cause big sql injection attack
	rows, err := db.Query(sql)
	if err != nil{
		return User{}, err
	}
	defer rows.Close()
	//var data []User
	var user = User{}
	for rows.Next(){
		err = rows.Scan(&user.Id, &user.Name)
		if err != nil{
			return User{}, err
		}
	}
	return user,nil

}
func SafeGetData(r *http.Request)([]User, error){
	db, err := database.Connect()
	if err != nil{
		return nil,err
	}
	defer db.Close()
	//get data from clien
	uid := r.URL.Query().Get("uid")
	sql := fmt.Sprintf("SELECT * FROM users where id=?") //set safe query

	stmtOut, err := db.Prepare(sql) //prepare statement 
	if err != nil{
		return nil, err
	}
	defer stmtOut.Close()
	var data []User
	var user = User{}
	err = stmtOut.QueryRow(uid).Scan(&user.Id, &user.Name)
	if err != nil{
		return nil, err
	}
	data = append(data,user)
	return data,nil

}